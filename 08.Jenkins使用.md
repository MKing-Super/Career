# Jenkinsä½¿ç”¨

## 1 CentOS7

java17

jenkins 2.469

```bash
mkdir -p /usr/lib/jvm
tar -xzf OpenJDK17U-jdk_x64_linux_hotspot_17.0.15_6.tar.gz -C /usr/lib/jvm

# è®¾ç½®ç¯å¢ƒå˜é‡
echo 'export JAVA_HOME=/usr/lib/jvm/jdk-17.0.15+6
export PATH=$JAVA_HOME/bin:$PATH' | sudo tee /etc/profile.d/java.sh

# åŠ è½½ç¯å¢ƒå˜é‡
source /etc/profile.d/java.sh

# éªŒè¯å®‰è£…
java -version









# jenkins å®‰è£…
mkdir -p /usr/local/jenkins/{bin,logs,conf,data}
chown -R $USER:$USER /usr/local/jenkins

cat > /usr/local/jenkins/conf/jenkins.conf <<EOF
JENKINS_HOME=/usr/local/jenkins/data
JENKINS_PORT=8080
JENKINS_LOG=/usr/local/jenkins/logs/jenkins.log
JENKINS_ERROR_LOG=/usr/local/jenkins/logs/jenkins-error.log
EOF


cp jenkins.war /usr/local/jenkins/bin/


sudo cat > /etc/systemd/system/jenkins.service <<EOF
[Unit]
Description=Jenkins CI Server
After=network.target

[Service]
User=$USER
EnvironmentFile=/usr/local/jenkins/conf/jenkins.conf
WorkingDirectory=/usr/local/jenkins/data
ExecStart=$JAVA_HOME/bin/java -jar /usr/local/jenkins/bin/jenkins.war \
  --httpPort=\${JENKINS_PORT} \
  --logfile=\${JENKINS_LOG} \
  --webroot=/usr/local/jenkins/data/war
StandardOutput=append:\${JENKINS_LOG}
StandardError=append:\${JENKINS_ERROR_LOG}
Restart=always

[Install]
WantedBy=multi-user.target
EOF


systemctl daemon-reload
systemctl start jenkins
systemctl enable jenkins

systemctl status jenkins
tail -f /usr/local/jenkins/logs/jenkins.log

firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
```

> systemctl stop jenkins

å­—ä½“é—®é¢˜

```bash
# å®‰è£…åŸºç¡€å­—ä½“åŒ…
sudo yum install -y fontconfig dejavu-sans-fonts dejavu-serif-fonts dejavu-sans-mono-fonts

# é‡å»ºå­—ä½“ç¼“å­˜
fc-cache -fv

# ç¼–è¾‘ systemd æœåŠ¡æ–‡ä»¶ï¼Œæ·»åŠ å­—ä½“ç›¸å…³ç¯å¢ƒå˜é‡ï¼š
sudo vi /etc/systemd/system/jenkins.service

# åœ¨ [Service] éƒ¨åˆ†æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
Environment="JAVA_TOOL_OPTIONS=-Djava.awt.headless=true -Djavax.accessibility.assistive_technologies="
Environment="FONTCONFIG_PATH=/etc/fonts"

# é‡å¯ Jenkins æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart jenkins
tail -f /usr/local/jenkins/logs/jenkins.log  # æ£€æŸ¥æ—¥å¿—
```



## 2 Termux

### åŸºæœ¬

```bash
# å®‰è£…å­—ä½“å’Œå­—ä½“é…ç½®
pkg install fontconfig -y
pkg install fontconfig-utils -y
pkg install ttf-dejavu -y

# é‡æ–°ç”Ÿæˆå­—ä½“é…ç½®
fc-cache -fv

# æ£€æŸ¥Javaå­—ä½“é…ç½®
mkdir -p ~/.config/fontconfig/conf.d

# åˆ›å»ºæˆ–ç¼–è¾‘å­—ä½“é…ç½®æ–‡ä»¶ï¼š
vim ~/.config/fontconfig/fonts.conf

# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<fontconfig>
    <dir>/data/data/com.termux/files/usr/share/fonts</dir>
    <cachedir>~/.cache/fontconfig</cachedir>
</fontconfig>


# è¿è¡Œä»¥ä¸‹å‘½ä»¤è®¾ç½®Javaå­—ä½“ç¯å¢ƒï¼š
export JAVA_OPTS="-Dawt.useSystemAAFontSettings=on -Dswing.aatext=true -Djava.awt.headless=false"

# å¦‚æœè¦æ°¸ä¹…è®¾ç½®ï¼Œå¯ä»¥æ·»åŠ åˆ°bashrcï¼š
echo 'export JAVA_OPTS="-Dawt.useSystemAAFontSettings=on -Dswing.aatext=true -Djava.awt.headless=false"' >> ~/.bashrc
source ~/.bashrc

# æ¸…ç†æ—§çš„Jenkinsç›®å½•
rm -rf ~/.jenkins


# ä¸‹è½½Jenkins WARåŒ…
wget https://get.jenkins.io/war-stable/latest/jenkins.war

# å¯åŠ¨Jenkins
java -jar jenkins.war --httpPort=9090
# åå°è¿è¡Œ
nohup java -jar jenkins.war --httpPort=9090 > jenkins.log 2>&1 &

# æŸ¥çœ‹æ˜¯å¦è¿è¡Œ
ps -ef --forest | grep 'jenkins'
```

ç¼–å†™jenkinsçš„å¯åŠ¨è„šæœ¬ï¼š

```shell
#!/bin/bash

# æ¨¡å—åç§°
MODULE_NAME="jenkins"
# JaråŒ…ã€æ—¥å¿—å­˜æ”¾ ç»å¯¹è·¯å¾„
PROJECT_RUN_PATH="/data/data/com.termux/files/home/projects"
JAR_FILE_PATH="${PROJECT_RUN_PATH}/jars"
JAR_FILE_LOG_PATH="${PROJECT_RUN_PATH}/logs"
LOG_FILE="${JAR_FILE_LOG_PATH}/${MODULE_NAME}.log"

# Jenkinså¯åŠ¨è„šæœ¬
cd $PROJECT_RUN_PATH
nohup java -jar jenkins.war --httpPort=9090 > $LOG_FILE 2>&1 &
echo "Jenkinså·²å¯åŠ¨ï¼ŒPID: $!"
```

### ä¼˜åŒ–

å¯åŠ¨è„šæœ¬

jenkins_start.sh

```bash
#!/bin/bash

# æ¨¡å—åç§°
MODULE_NAME="jenkins"
# JaråŒ…ã€æ—¥å¿—å­˜æ”¾ ç»å¯¹è·¯å¾„
PROJECT_RUN_PATH="/data/data/com.termux/files/home/projects"
JAR_FILE_PATH="${PROJECT_RUN_PATH}/jars"
JAR_FILE_LOG_PATH="${PROJECT_RUN_PATH}/logs"
LOG_FILE="${JAR_FILE_LOG_PATH}/${MODULE_NAME}.log"

# 1. åœæ­¢ Jenkins
pkill -f jenkins.war

JAVA_OPTS="
-Xmx1024m
-Xms512m
-XX:MaxRAMPercentage=70.0
-XX:InitialRAMPercentage=25.0
-XX:MinRAMPercentage=15.0
-XX:+UseG1GC
-XX:G1HeapRegionSize=8M  
-XX:MaxGCPauseMillis=100   
-XX:G1ReservePercent=20     
-XX:InitiatingHeapOccupancyPercent=45
-XX:ConcGCThreads=2         
-XX:ParallelGCThreads=4      
-XX:G1MixedGCCountTarget=8
-XX:G1HeapWastePercent=5
"

# Jenkinså¯åŠ¨è„šæœ¬
cd $PROJECT_RUN_PATH
nohup java $JAVA_OPTS -jar jenkins.war --httpPort=9090 > $LOG_FILE 2>&1 &
echo "æ—¥å¿— tail -f $LOG_FILE"
echo "Jenkinså·²å¯åŠ¨ï¼ŒPID: $!"
```

æ¸…ç†ç¼“å­˜

jenkins_safe_clean.sh

```bash
#!/bin/bash
# jenkins_safe_cache_clean.sh

echo "ğŸ§¹ Jenkins å®‰å…¨ç¼“å­˜æ¸…ç†ï¼ˆä¿ç•™æ ·å¼ï¼‰..."
JENKINS_HOME="/data/data/com.termux/files/home/.jenkins"

# åªæ¸…ç†è¿™äº›ç‰¹å®šç¼“å­˜ï¼Œä¸åˆ é™¤æ ·å¼
SAFE_TO_REMOVE=(
    "$JENKINS_HOME/cache"                    # è¿‡æœŸç¼“å­˜
    "$JENKINS_HOME/plugins/.cache"          # æ’ä»¶ç¼–è¯‘ç¼“å­˜
    "$JENKINS_HOME/updates"                 # æ›´æ–°ç¼“å­˜
    "/tmp/jenkins*"                         # ä¸´æ—¶æ–‡ä»¶
    "/tmp/hudson*"                          # ä¸´æ—¶æ–‡ä»¶
)

# ä¿æŠ¤è¿™äº›æ ·å¼å’Œè„šæœ¬æ–‡ä»¶
PROTECTED_DIRS=(
    "$JENKINS_HOME/war/css"
    "$JENKINS_HOME/war/js"
    "$JENKINS_HOME/war/images"
    "$JENKINS_HOME/war/scripts"
    "$JENKINS_HOME/war/styles"
)

echo "ä¿æŠ¤æ ·å¼ç›®å½•..."
for dir in "${PROTECTED_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        echo "âœ… ä¿æŠ¤: $dir"
    fi
done

echo -e "\næ¸…ç†å®‰å…¨ç¼“å­˜..."
for target in "${SAFE_TO_REMOVE[@]}"; do
    if [ -e "$target" ]; then
        size=$(du -sh "$target" 2>/dev/null | cut -f1 || echo "0")
        rm -rf "$target"
        echo "âœ… æ¸…ç†: $target (${size})"
    fi
done

# æ¸…ç†å·¥ä½œç©ºé—´ä½†ä¸åˆ é™¤ç›®å½•ç»“æ„
if [ -d "$JENKINS_HOME/workspace" ]; then
    find "$JENKINS_HOME/workspace" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | \
        xargs rm -rf 2>/dev/null
    echo "âœ… æ¸…ç†å·¥ä½œç©ºé—´å†…å®¹"
fi

echo -e "\nğŸ“Š æ¸…ç†å®Œæˆï¼Œæ‰€æœ‰æ ·å¼å·²ä¿ç•™"
echo "ğŸŒ æ— éœ€é‡å¯ Jenkinsï¼Œç«‹å³ç”Ÿæ•ˆ"
```

æ¸…é™¤å·²æ„å»ºå†å²

```bash

rm -rf /data/data/com.termux/files/home/.jenkins/jobs/*/builds/*
```

