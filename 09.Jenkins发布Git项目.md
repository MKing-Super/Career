# Jenkins发布Git项目

（1）安装必要插件

- **Git Plugin**（默认已安装）
- **Maven Integration Plugin**（用于构建 Spring 项目）
- **Publish Over SSH**（可选，用于部署）

```bash
# 确保已安装 Git
yum install -y git

# 生成 SSH 密钥
ssh-keygen -t rsa -b 4096 -C "jenkins@C1"
cat ~/.ssh/id_rsa.pub
# 将公钥添加到GitHub

# 测试连接
ssh -T git@github.com

# 安装Maven
yum install -y maven
# Maven 换源
mkdir -p ~/.m2
cp /usr/share/maven/conf/settings.xml ~/.m2/settings.xml
vim ~/.m2/settings.xml

#在 <mirrors> 标签内添加国内镜像源
<mirror>
  <id>aliyunmaven</id>
  <mirrorOf>*</mirrorOf>
  <name>阿里云公共仓库</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>

# 克隆项目
mkdir -p ~/projects
cd ~/projects
git clone git@github.com:MKing-Super/Career.git
cd Career
```

## 1.手动构建和运行项目

```bash
# 使用Maven构建项目 与pom.xml在同一层
mvn clean package
```

> 项目pom.xml配置：
>
> <build>
>     <plugins>
>         <plugin>
>             <groupId>org.springframework.boot</groupId>
>             <artifactId>spring-boot-maven-plugin</artifactId>
>             <version>2.3.12.RELEASE</version> <!-- 与 Spring Boot 版本一致 -->
>             <executions>
>                 <execution>
>                     <goals>
>                         <goal>repackage</goal> <!-- 重新打包成可执行 JAR -->
>                     </goals>
>                 </execution>
>             </executions>
>         </plugin>
>     </plugins>
> </build>

```bash
# 前台运行（Ctrl+C停止）
java -jar target/*.jar > app.log 2>&1 &

# 后台运行
nohup java -jar target/*.jar > app.log 2>&1 &
```

> 防火墙打开端口：
>
> firewall-cmd --permanent --add-port=8761/tcp
> firewall-cmd --reload

```bash
# 查看进程
ps aux | grep java

# 查看日志
tail -f test.log

# 检查端口（默认8080）
yum install -y net-tools
netstat -tulnp | grep 8761
ss -tulnp | grep 8761
```

> 根据端口杀死进程：
>
> yum install -y psmisc
>
> ```bash
> # 替换 8080 为你的端口号
> fuser -n tcp 8761  
> # 8761/tcp:            25714
> kill -9 25714
> ```

## 2.通过Jenkins自动化部署

2.1 凭证配置

1. 登录Jenkins控制台

2. 点击左侧菜单中的 **"Manage Jenkins"**

3. Security -> Credentials

4. 点击 System

5. 点击 Global credentials

6. 点击 Add Credentials

7. **Kind** (类型): 选择 **"SSH Username with private key"**

   **Scope**: 保持默认 **"Global"**

   **ID**: 可留空（Jenkins会自动生成）或自定义一个ID

   **Description**: 输入描述，如"GitHub SSH Key for Career Project"

   **Username**: 输入你的GitHub用户名

   **Private Key**:

   - 选择 **"Enter directly"**

   - 点击 **"Add"** 按钮

   - 粘贴你的 **私钥内容** (通常是 `~/.ssh/id_rsa` 文件内容)

     text

   - ```
     -----BEGIN RSA PRIVATE KEY-----
     [你的私钥内容]
     -----END RSA PRIVATE KEY-----
     ```

   **Passphrase**: 如果私钥有密码，在此输入

   点击 **"Create"** 按钮

   

2.2 过程

1 安转 Pipeline 插件

```bash
# 重启jenkins
systemctl restart jenkins
```

2 New Item

```
Enter an item name：输入名称
Career-Deployment

选择Freestyle project

OK
```

3 进入General

```
Description：
你的描述~
```

4 Source Code Management ：点击 Git

```
Repository URL：
git@github.com:MKing-Super/Career.git

Credentials：
选择 2.1 中配置的凭证

Branches to build：
*/main
```

5 Build Steps

```bash
1.Add build step
选 Invoke top-level Maven targets
Goals：
clean package

Advanced - POM：
Projects/springcloud-demo/eureka-server/pom.xml


2.Add build step
选 Execute shell


#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'eureka' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/eureka-server/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > ./Projects/springcloud-demo/eureka-server/test.log 2>&1 &
echo "Application started. Logs: ./Projects/springcloud-demo/eureka-server/test.log"
```

6 Save

7 Build Now

> 防火墙打开端口：
>
> firewall-cmd --permanent --add-port=8761/tcp
> firewall-cmd --reload
>
> 
>
> 查看日志：
>
> tail -f test.log

其他站点配置

eureka-server

```bash
#!/bin/bash

# 停止正在运行的 eureka-server 实例
APP_PID=$(ps -ef | grep 'eureka-server' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/eureka-server/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/eureka-server.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/eureka-server.log"
```

work-api

```bash
# 父pom打包
FATHER_PATH=$(pwd ./)
cd "$FATHER_PATH/Projects/springcloud-demo"
mvn clean install -N

# 本站点的api
cd "$FATHER_PATH/Projects/springcloud-demo/work-api"
mvn clean install -N
```

work-service

```bash
#!/bin/bash

# 停止正在运行的 work-service 实例
APP_PID=$(ps -ef | grep 'work-service' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/work-service/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/work-service.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/work-service.log"
```

work-admin

```bash
#!/bin/bash

# 停止正在运行的 work-admin 实例
APP_PID=$(ps -ef | grep 'work-admin' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/work-admin/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/work-admin.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/work-admin.log"
```

## 3.Jenkins纯shell自动化部署

> 在 /root 拉取代码
>
> ```
> cd /root
> git clone git@github.com:MKing-Super/Career.git
> mkdir logs
> ```

1 Build Steps

Add build step
选 Execute shell

eureka-server(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'eureka-server' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/eureka-server && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/eureka-server/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/eureka-server.log 2>&1 &
echo "-----------------------------------------------------------------------"
echo "$(hostname):9100"
echo "-----------------------------------------------------------------------"
echo "Application started. Logs: tail -f /root/logs/eureka-server.log"
```

api-gateway(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'api-gateway' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/api-gateway && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/api-gateway/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/api-gateway.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/api-gateway.log"
```

work-api(shell)

```bash
# 父pom打包
cd /root/Career/Projects/springcloud-demo
mvn clean install -N

# 本站点的api
cd /root/Career/Projects/springcloud-demo/work-api
mvn clean install -N
```

work-service(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'work-service' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/work-service && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/work-service/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/work-service.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/work-service.log"
```

work-admin(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'work-admin' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/work-admin && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/work-admin/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/work-admin.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/work-admin.log"
```

## 4.Jenkins跨服务器发布

A-IP(source)：10.50.10.113

B-IP(target)：10.100.213.41

```bash
# A
# 生成密钥对(若有则忽略)
# ssh-keygen -t rsa

# 将公钥上传到服务器B
ssh-copy-id root@10.100.213.41
# 公钥位置 /root/.ssh/authorized_keys

# ssh无密码登录
ssh root@10.100.213.41

# A向B传文件
scp /root/Career/Projects/springcloud-demo/work-service/target/work-service-1.0.0-SNAPSHOT.jar root@10.100.213.41:/root/mk
```

> jenkins 无法传输文件问题：
>
> jenkins 无权限：
>
> ```bash
> # 允许所有用户读取
> chmod a+r /root/Career/Projects/springcloud-demo/work-service/target/work-service-1.0.0-SNAPSHOT.jar
> ```
>

### eureka-server

eureka-server(shell)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="eureka-server"
# eureka注册中心IP、端口
EUREKA_IP="10.50.10.113"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="10.50.10.113"
TARGET_PORT="9100"
# Jar文件、日志
JAVA_PATH="/bin/java"	# which java
JAR_FILE_PATH="/root/mk/eureka-server"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
mkdir -p "${JAR_FILE_PATH}"
mkdir -p "${JAR_RILE_LOG_PATH}"
mv $JAR_FILE "${JAR_FILE_PATH}/$FILE_NAME"

# 停止正在运行的实例
if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi

echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
>> "$LOG_FILE" 2>&1 &

# 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
```



### api-gateway

api-gateway(shell)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="api-gateway"
# eureka注册中心IP、端口
EUREKA_IP="10.50.10.113"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="10.50.10.113"
TARGET_PORT="9200"
# Jar文件、日志
JAVA_PATH="/bin/java"	# which java
JAR_FILE_PATH="/root/mk/api-gateway"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
mkdir -p "${JAR_FILE_PATH}"
mkdir -p "${JAR_RILE_LOG_PATH}"
mv $JAR_FILE "${JAR_FILE_PATH}/$FILE_NAME"

# 停止正在运行的实例
if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi

echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
--eureka.client.service-url.defaultZone="http://${EUREKA_IP}:${EUREKA_PORT}/eureka/" \
>> "$LOG_FILE" 2>&1 &

# 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
```



### work

work-api(shell)

```bash
# 模块名称
MODULE_NAME="work-api"

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

# 父pom打包
cd /root/Career/Projects/springcloud-demo
mvn clean install -N

# 本站点的api
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME}
mvn clean install -N
```

work-service(remote)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="work-service"
# eureka注册中心IP、端口
EUREKA_IP="10.50.10.113"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="10.100.213.41"
TARGET_PORT="9001"
# Mysql
MYSQL_IP="10.50.10.29"
MYSQL_PORT="3306"
DATABASE_NAME="home"
MYSQL_USERNAME="root"
MYSQL_PASSWORD="123"
# Jar文件、日志
JAVA_PATH="/usr/local/java/bin/java"	# which java
JAR_FILE_PATH="/root/mk/work"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
ssh root@${TARGET_IP} "mkdir -p '${JAR_FILE_PATH}';"
scp $JAR_FILE root@${TARGET_IP}:${JAR_FILE_PATH}  && \

ssh root@${TARGET_IP} << EOF
  echo "连接服务器 ${TARGET_IP}， 停止正在运行的实例"
  if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi
  mkdir -p "${JAR_FILE_PATH}"
  mkdir -p "${JAR_RILE_LOG_PATH}"
  echo "启动jar"
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
--spring.datasource.url="jdbc:mysql://${MYSQL_IP}:${MYSQL_PORT}/${DATABASE_NAME}?useSSL=false&characterEncoding=utf8" \
--spring.datasource.username="${MYSQL_USERNAME}" \
--spring.datasource.password="${MYSQL_PASSWORD}" \
--eureka.client.service-url.defaultZone="http://${EUREKA_IP}:${EUREKA_PORT}/eureka/" \
>> "$LOG_FILE" 2>&1 &
  

  # 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
EOF
```

> 注：**SSH环境变量问题**：SSH非交互式登录时，不会加载 `~/.bashrc`或 `/etc/profile`，导致 `java`命令找不到。

work-admin(remote)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="work-admin"
# eureka注册中心IP、端口
EUREKA_IP="10.50.10.113"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="10.100.213.41"
TARGET_PORT="9002"
# Jar文件、日志
JAVA_PATH="/usr/local/java/bin/java"	# which java
JAR_FILE_PATH="/root/mk/work"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
ssh root@${TARGET_IP} "mkdir -p '${JAR_FILE_PATH}';"
scp $JAR_FILE root@${TARGET_IP}:${JAR_FILE_PATH}  && \

ssh root@${TARGET_IP} << EOF
  echo "连接服务器 ${TARGET_IP}， 停止正在运行的实例"
  if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi
  mkdir -p "${JAR_FILE_PATH}"
  mkdir -p "${JAR_RILE_LOG_PATH}"
  echo "启动jar"
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
--eureka.client.service-url.defaultZone="http://${EUREKA_IP}:${EUREKA_PORT}/eureka/" \
>> "$LOG_FILE" 2>&1 &
  
  # 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
EOF
```

### home

home-api(shell)

```bash
# 模块名称
MODULE_NAME="home-api"

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

# 父pom打包
cd /root/Career/Projects/springcloud-demo
mvn clean install -N

# 本站点的api
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME}
mvn clean install -N
```

home-service(remote)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="home-service"
# eureka注册中心IP、端口
EUREKA_IP="192.168.1.9"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="192.168.1.6"
TARGET_PORT="9003"
# Mysql
MYSQL_IP="192.168.1.5"
MYSQL_PORT="3306"
DATABASE_NAME="home"
MYSQL_USERNAME="root"
MYSQL_PASSWORD="123"
# Jar文件、日志
JAVA_PATH="/usr/local/java/bin/java"	# which java
JAR_FILE_PATH="/root/mk/home"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
ssh root@${TARGET_IP} "mkdir -p '${JAR_FILE_PATH}';"
scp $JAR_FILE root@${TARGET_IP}:${JAR_FILE_PATH}  && \

ssh root@${TARGET_IP} << EOF
  echo "连接服务器 ${TARGET_IP}， 停止正在运行的实例"
  if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi
  mkdir -p "${JAR_FILE_PATH}"
  mkdir -p "${JAR_RILE_LOG_PATH}"
  echo "启动jar"
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
--spring.datasource.url="jdbc:mysql://${MYSQL_IP}:${MYSQL_PORT}/${DATABASE_NAME}?useSSL=false&characterEncoding=utf8" \
--spring.datasource.username="${MYSQL_USERNAME}" \
--spring.datasource.password="${MYSQL_PASSWORD}" \
--eureka.client.service-url.defaultZone="http://${EUREKA_IP}:${EUREKA_PORT}/eureka/" \
>> "$LOG_FILE" 2>&1 &
  

  # 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
EOF
```

home-admin(remote)

```bash
#!/bin/bash

# 模块名称
MODULE_NAME="home-admin"
# eureka注册中心IP、端口
EUREKA_IP="192.168.1.9"
EUREKA_PORT="9100"
# 项目运行的服务器IP、端口
TARGET_IP="192.168.1.6"
TARGET_PORT="9004"
# Jar文件、日志
JAVA_PATH="/usr/local/java/bin/java"	# which java
JAR_FILE_PATH="/root/mk/home"
JAR_RILE_LOG_PATH="/root/mk/logs"
LOG_FILE="${JAR_RILE_LOG_PATH}/${MODULE_NAME}.log"
# 健康检查
APP_URL="http://${TARGET_IP}:${TARGET_PORT}/actuator/health"


echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."
echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/${MODULE_NAME} && \
mvn clean package && \
echo "Maven打包 结束..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/${MODULE_NAME}/target/*.jar) && \
FILE_NAME=$(basename $JAR_FILE) && \
echo "文件传输"
ssh root@${TARGET_IP} "mkdir -p '${JAR_FILE_PATH}';"
scp $JAR_FILE root@${TARGET_IP}:${JAR_FILE_PATH}  && \

ssh root@${TARGET_IP} << EOF
  echo "连接服务器 ${TARGET_IP}， 停止正在运行的实例"
  if pkill -f "${MODULE_NAME}"; then
    echo "${TARGET_IP} 杀死了 ${MODULE_NAME} 进程"
  else
    echo "${MODULE_NAME} 不存在 或 无法杀死"
  fi
  mkdir -p "${JAR_FILE_PATH}"
  mkdir -p "${JAR_RILE_LOG_PATH}"
  echo "启动jar"
nohup "${JAVA_PATH}" -jar ${JAR_FILE_PATH}/$FILE_NAME \
--server.port="${TARGET_PORT}" \
--spring.application.name="${MODULE_NAME}" \
--eureka.client.service-url.defaultZone="http://${EUREKA_IP}:${EUREKA_PORT}/eureka/" \
>> "$LOG_FILE" 2>&1 &
  
  # 健康检查循环
  i=0
  for ((; i<30; i++)); do
    echo $(date "+%Y-%m-%d %H:%M:%S")
    if curl -sSf --max-time 2 "${APP_URL}" | grep -q '"status":"UP"'; then
      echo -e "\n[成功] Spring Boot 应用已启动！"
      break
    fi
    sleep 5
  done
  # 判断是否超时
  if [ ${i:-0} -eq 30 ]; then
    echo -e "\n[错误] 应用启动超时！请检查日志。"
    exit 1
  fi
  
  echo "${TARGET_IP} 项目启动。查看日志： tail -f $LOG_FILE"
  echo "健康检查  ${APP_URL}"
EOF
```

### 其他

1.CentOS7 多次使用SCP/SSH传输文件导致SSH连接失败问题解决方案

```bash
# 配置SSH
vi /etc/ssh/sshd_config

# 修改或添加以下参数：
MaxStartups 30:60:100
MaxSessions 50
ClientAliveInterval 60
ClientAliveCountMax 3
# MaxStartups：允许的未认证连接数（格式：起始值:增长率:最大值）
# MaxSessions：每个连接允许的最大会话数
# ClientAliveInterval：服务器检查客户端活动的时间间隔(秒)
# ClientAliveCountMax：服务器检查客户端活动的次数


# 重启SSH服务：
systemctl restart sshd
```

