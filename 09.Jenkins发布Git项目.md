# Jenkins发布Git项目

（1）安装必要插件

- **Git Plugin**（默认已安装）
- **Maven Integration Plugin**（用于构建 Spring 项目）
- **Publish Over SSH**（可选，用于部署）

```bash
# 确保已安装 Git
yum install -y git

# 生成 SSH 密钥
ssh-keygen -t rsa -b 4096 -C "jenkins@C1"
cat ~/.ssh/id_rsa.pub
# 将公钥添加到GitHub

# 测试连接
ssh -T git@github.com

# 安装Maven
yum install -y maven
# Maven 换源
mkdir -p ~/.m2
cp /usr/share/maven/conf/settings.xml ~/.m2/settings.xml
vim ~/.m2/settings.xml

#在 <mirrors> 标签内添加国内镜像源
<mirror>
  <id>aliyunmaven</id>
  <mirrorOf>*</mirrorOf>
  <name>阿里云公共仓库</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>

# 克隆项目
mkdir -p ~/projects
cd ~/projects
git clone git@github.com:MKing-Super/Career.git
cd Career
```

## 1.手动构建和运行项目

```bash
# 使用Maven构建项目 与pom.xml在同一层
mvn clean package
```

> 项目pom.xml配置：
>
> <build>
>     <plugins>
>         <plugin>
>             <groupId>org.springframework.boot</groupId>
>             <artifactId>spring-boot-maven-plugin</artifactId>
>             <version>2.3.12.RELEASE</version> <!-- 与 Spring Boot 版本一致 -->
>             <executions>
>                 <execution>
>                     <goals>
>                         <goal>repackage</goal> <!-- 重新打包成可执行 JAR -->
>                     </goals>
>                 </execution>
>             </executions>
>         </plugin>
>     </plugins>
> </build>

```bash
# 前台运行（Ctrl+C停止）
java -jar target/*.jar > app.log 2>&1 &

# 后台运行
nohup java -jar target/*.jar > app.log 2>&1 &
```

> 防火墙打开端口：
>
> firewall-cmd --permanent --add-port=8761/tcp
> firewall-cmd --reload

```bash
# 查看进程
ps aux | grep java

# 查看日志
tail -f test.log

# 检查端口（默认8080）
yum install -y net-tools
netstat -tulnp | grep 8761
ss -tulnp | grep 8761
```

> 根据端口杀死进程：
>
> yum install -y psmisc
>
> ```bash
> # 替换 8080 为你的端口号
> fuser -n tcp 8761  
> # 8761/tcp:            25714
> kill -9 25714
> ```

## 2.通过Jenkins自动化部署

2.1 凭证配置

1. 登录Jenkins控制台

2. 点击左侧菜单中的 **"Manage Jenkins"**

3. Security -> Credentials

4. 点击 System

5. 点击 Global credentials

6. 点击 Add Credentials

7. **Kind** (类型): 选择 **"SSH Username with private key"**

   **Scope**: 保持默认 **"Global"**

   **ID**: 可留空（Jenkins会自动生成）或自定义一个ID

   **Description**: 输入描述，如"GitHub SSH Key for Career Project"

   **Username**: 输入你的GitHub用户名

   **Private Key**:

   - 选择 **"Enter directly"**

   - 点击 **"Add"** 按钮

   - 粘贴你的 **私钥内容** (通常是 `~/.ssh/id_rsa` 文件内容)

     text

   - ```
     -----BEGIN RSA PRIVATE KEY-----
     [你的私钥内容]
     -----END RSA PRIVATE KEY-----
     ```

   **Passphrase**: 如果私钥有密码，在此输入

   点击 **"Create"** 按钮

   

2.2 过程

1 安转 Pipeline 插件

```bash
# 重启jenkins
systemctl restart jenkins
```

2 New Item

```
Enter an item name：输入名称
Career-Deployment

选择Freestyle project

OK
```

3 进入General

```
Description：
你的描述~
```

4 Source Code Management ：点击 Git

```
Repository URL：
git@github.com:MKing-Super/Career.git

Credentials：
选择 2.1 中配置的凭证

Branches to build：
*/main
```

5 Build Steps

```bash
1.Add build step
选 Invoke top-level Maven targets
Goals：
clean package

Advanced - POM：
Projects/springcloud-demo/eureka-server/pom.xml


2.Add build step
选 Execute shell


#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'eureka' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/eureka-server/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > ./Projects/springcloud-demo/eureka-server/test.log 2>&1 &
echo "Application started. Logs: ./Projects/springcloud-demo/eureka-server/test.log"
```

6 Save

7 Build Now

> 防火墙打开端口：
>
> firewall-cmd --permanent --add-port=8761/tcp
> firewall-cmd --reload
>
> 
>
> 查看日志：
>
> tail -f test.log

其他站点配置

eureka-server

```bash
#!/bin/bash

# 停止正在运行的 eureka-server 实例
APP_PID=$(ps -ef | grep 'eureka-server' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/eureka-server/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/eureka-server.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/eureka-server.log"
```

work-api

```bash
# 父pom打包
FATHER_PATH=$(pwd ./)
cd "$FATHER_PATH/Projects/springcloud-demo"
mvn clean install -N

# 本站点的api
cd "$FATHER_PATH/Projects/springcloud-demo/work-api"
mvn clean install -N
```

work-service

```bash
#!/bin/bash

# 停止正在运行的 work-service 实例
APP_PID=$(ps -ef | grep 'work-service' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/work-service/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/work-service.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/work-service.log"
```

work-admin

```bash
#!/bin/bash

# 停止正在运行的 work-admin 实例
APP_PID=$(ps -ef | grep 'work-admin' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

# 启动新实例
JAR_FILE=$(ls ./Projects/springcloud-demo/work-admin/target/*.jar)
echo "Starting application with JAR: $JAR_FILE"
nohup java -jar $JAR_FILE > /usr/local/jenkins/logs/work-admin.log 2>&1 &
echo "Application started. Logs: /usr/local/jenkins/logs/work-admin.log"
```

## 3.Jenkins纯shell自动化部署

> 在 /root 拉取代码
>
> ```
> cd /root
> git clone git@github.com:MKing-Super/Career.git
> mkdir logs
> ```

1 Build Steps

Add build step
选 Execute shell

eureka-server(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'eureka-server' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/eureka-server && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/eureka-server/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/eureka-server.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/eureka-server.log"
```

api-gateway(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'api-gateway' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/api-gateway && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/api-gateway/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/api-gateway.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/api-gateway.log"
```

work-api(shell)

```bash
# 父pom打包
cd /root/Career/Projects/springcloud-demo
mvn clean install -N

# 本站点的api
cd /root/Career/Projects/springcloud-demo/work-api
mvn clean install -N
```

work-service(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'work-service' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/work-service && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/work-service/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/work-service.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/work-service.log"
```

work-admin(shell)

```bash
#!/bin/bash

# 停止正在运行的实例
APP_PID=$(ps -ef | grep 'work-admin' | grep -v grep | awk '{print $2}')
if [ -n "$APP_PID" ]; then
  echo "Stopping existing application with PID $APP_PID"
  kill $APP_PID
  sleep 5
fi

echo "更新代码 开始..."
cd /root/Career && \
git pull git@github.com:MKing-Super/Career.git && \
echo "更新代码 完成..."

echo "Maven打包 开始..."
cd /root/Career/Projects/springcloud-demo/work-admin && \
mvn clean package && \
echo "Maven打包 结束..."

echo "启动新实例..."
JAR_FILE=$(ls /root/Career/Projects/springcloud-demo/work-admin/target/*.jar) && \
echo " $JAR_FILE" && \
echo "关键设置：禁止Jenkins杀死衍生进程"
export BUILD_ID=dontKillMe
nohup java -jar $JAR_FILE > /root/logs/work-admin.log 2>&1 &
echo "Application started. Logs: tail -f /root/logs/work-admin.log"
```

## 4.Jenkins跨服务器发布

A-IP(source)：10.50.10.113

B-IP(target)：10.100.213.41

```bash
# A
# 生成密钥对(若有则忽略)
# ssh-keygen -t rsa

# 将公钥上传到服务器B
ssh-copy-id root@10.100.213.41
# 公钥位置 /root/.ssh/authorized_keys

ssh root@10.100.213.41

```













