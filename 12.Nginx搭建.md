# Nginx搭建

## 1 Centos7

手动安装

```bash
# 安装必要的开发工具和依赖项：
yum groupinstall "Development Tools" -y
yum install pcre-devel zlib-devel openssl-devel -y
yum install wget -y

# 下载
wget http://nginx.org/download/nginx-1.25.3.tar.gz
tar -zxvf nginx-1.25.3.tar.gz
cd nginx-1.25.3

# 编译安装 Nginx
# 配置编译选项
./configure \
--prefix=/usr/local/nginx \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_stub_status_module \
--with-threads \
--with-file-aio

# 编译并安装：
make
make install

# 创建 systemd 服务文件
vi /etc/systemd/system/nginx.service

# 添加以下内容：
[Unit]
Description=The NGINX HTTP and reverse proxy server
After=syslog.target network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target


#启用并启动 Nginx 服务
systemctl daemon-reload
systemctl enable nginx
systemctl start nginx

# 开放端口
firewall-cmd --add-port=80/tcp --permanent
firewall-cmd --reload

# 需要开放 HTTP 和 HTTPS 端口：
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-service=https
firewall-cmd --reload

# 检查 Nginx 是否运行：
systemctl status nginx

# 主要配置文件位于 /usr/local/nginx/conf/nginx.conf
# 修改配置后，测试并重新加载
/usr/local/nginx/sbin/nginx -t
systemctl reload nginx
```

> Nginx 状态异常：
>
> netstat -tulnp | grep 80
> skill -9 <PID>  # 替换 <PID> 为占用 80 端口的进程 ID

```bash
# 再次尝试启动 Nginx：
systemctl restart nginx
```

卸载

```bash
# 停止 Nginx 服务
systemctl stop nginx
pkill -9 nginx  # 确保所有nginx进程终止

# 删除 Nginx 安装目录
rm -rf /usr/local/nginx

# 删除 systemd 服务文件
rm /etc/systemd/system/nginx.service
systemctl daemon-reload

# 删除 Nginx 相关文件和日志
rm -rf /var/log/nginx/
rm -f /etc/nginx/  # 如果存在旧配置

# 删除 Nginx 用户（如果创建过）
userdel -r nginx  # 如果安装时创建了nginx用户

# 清理环境变量
sed -i '/nginx/d' ~/.bashrc
sed -i '/nginx/d' /etc/profile
source ~/.bashrc

# 验证卸载
which nginx          # 应返回无结果
nginx -v             # 应提示"command not found"
systemctl status nginx  # 应提示"Unit nginx.service not found"

# 清除编译残留文件
rm -rf ~/nginx-*      # 删除下载的源码包和解压目录

# 防火墙规则清理
sudo firewall-cmd --remove-port=80/tcp --permanent
sudo firewall-cmd --remove-port=443/tcp --permanent
sudo firewall-cmd --reload
```



简单配置

```bash
cd /usr/local/nginx/conf
vi /usr/local/nginx/conf/nginx.conf


# nginx.conf 内容
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/json;
    sendfile      on;
    keepalive_timeout 65;

    # 日志格式
    log_format domain_log '[$time_local] $host $remote_addr "$request" $status';

    # 定义上游网关
    upstream api_gateway {
        server 127.0.0.1:9200;
        keepalive 32;
    }

    # Work管理后台配置
    server {
        listen       80;
        server_name  work.mk.com;  # 替换为真实域名

        location / {
			rewrite ^/(.*)$ /work-admin/$1 break; 
			proxy_pass http://api_gateway/;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
	
			# 性能优化
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_read_timeout 300s;
		}
    }
	
	# home管理后台配置
    server {
        listen       80;
        server_name  home.mk.com;  # 替换为真实域名

        location / {
			rewrite ^/(.*)$ /home-admin/$1 break; 
			proxy_pass http://api_gateway/;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
	
			# 性能优化
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_read_timeout 300s;
		}
    }

    # 默认域名拦截
    server {
        listen 80 default_server;
        server_name _;
        return 403 "Access Denied";
    }
}








# 检查配置语法：
/usr/local/nginx/sbin/nginx -t
# 重载配置
systemctl reload nginx
```

> SwitchHost：
>
> 10.50.10.113 home.mk.com
> 10.50.10.113 work.mk.com



## 2 Termux

```bash
# 更新和升级包
pkg update && pkg upgrade

# 安装编译工具
pkg install build-essential clang make cmake

# 安装 Nginx 核心依赖
pkg install openssl openssl-tool
# pkg install openssl openssl-tool openssl-dev
# 说明：​ Termux 中的 openssl包已经包含了运行库和开发头文件，所以你不需要像在其他 Linux 发行版中那样安装单独的 -dev包。
pkg install pcre
pkg install zlib
pkg install libcrypt

# 下载源码
pkg install wget
wget http://nginx.org/download/nginx-1.25.3.tar.gz
tar -zxvf nginx-1.25.3.tar.gz
cd nginx-1.25.3

# 配置
./configure \
    --prefix=$PREFIX/nginx \
    --sbin-path=$PREFIX/bin/nginx \
    --conf-path=$PREFIX/etc/nginx/nginx.conf \
    --pid-path=$PREFIX/var/run/nginx.pid \
    --lock-path=$PREFIX/var/run/nginx.lock \
    --http-log-path=$PREFIX/var/log/nginx/access.log \
    --error-log-path=$PREFIX/var/log/nginx/error.log \
    --with-http_ssl_module \
    --with-http_gzip_static_module \
    --with-http_v2_module \
    --with-http_realip_module \
    --with-http_stub_status_module \
    --with-ld-opt="-lcrypt"
    
    
# 改代码 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
vim src/event/modules/ngx_epoll_module.c
594
601
注释

vim src/event/ngx_event.h
349
350
// 找到这两行：
#define NGX_READ_EVENT     (EPOLLIN|EPOLLRDHUP)
#define NGX_WRITE_EVENT    EPOLLOUT
// 修改为：
#define NGX_READ_EVENT     (1|8192)  // EPOLLIN=1, EPOLLRDHUP=8192
#define NGX_WRITE_EVENT    4         // EPOLLOUT=4

vim src/http/v2/ngx_http_v2_filter_module.c
// 第118行左右
static const u_char nginx[5] = "\x84\xaa\x63\x55\xe7";
// 改为：
static const u_char nginx[6] = "\x84\xaa\x63\x55\xe7";
// 第121行左右
"\x8b\x84\x84\x2d\x69\x5b\x05\x44\x3c\x86\xaa\x6f";
// 对应的数组声明，找到并增加大小：
static const u_char nginx[12] = "...";
// 改为：
static const u_char nginx[13] = "...";

# 清理
make distclean 2>/dev/null || true
rm -rf objs Makefile 2>/dev/null || true

# <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<


    
# 编译安装
make
make install
```

> **$PREFIX 的绝对路径**
>
> .../files/usr $ cd $PREFIX
> .../files/usr $ pwd
> /data/data/com.termux/files/usr















