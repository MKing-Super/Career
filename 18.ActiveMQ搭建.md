# ActiveMQ搭建

JDK 11+

ActiveMQ 5.18.3

## 1.配置

```bash
# 解压
tar -xzf apache-activemq-5.18.3-bin.tar.gz

# 移动
mv apache-activemq-5.18.3 /opt/activemq

# 创建无法登录的用户，以用于activemq
useradd -r -s /sbin/nologin activemq

# 授权activemq用户可用的文件权限
chown -R activemq:activemq /opt/activemq

# 当用户 登录 系统时，会执行 /etc/profile，进而执行 /etc/profile.d/*.sh中的所有脚本。
cd /etc/profile.d/

# 写入.sh（内容↓）
vi activemq.sh
```

> ```bash
> export ACTIVEMQ_HOME=/opt/activemq
> export PATH=$PATH:$ACTIVEMQ_HOME/bin
> ```

```bash
# 让对系统全局配置的修改立即在当前 Shell 中生效，而无需用户注销后重新登录
source /etc/profile

# activemq配置文件夹
cd /opt/activemq/conf/

# 备份
cp activemq.xml activemq.xml.bak

# 配置核心参数(修改，内容↓)
vi activemq.xml
```

> ```xml
> <beans
>   xmlns="http://www.springframework.org/schema/beans"
>   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
>   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
>   http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd">
> 
>     <bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
>         <property name="locations">
>             <value>file:${activemq.conf}/credentials.properties</value>
>         </property>
>     </bean>
> 
> 
> <broker xmlns="http://activemq.apache.org/schema/core" brokerName="broker1" dataDirectory="${activemq.data}">
> 
>     <!-- 持久化配置（KahaDB） -->
>     <persistenceAdapter>
>         <kahaDB directory="${activemq.data}/kahadb"/>
>     </persistenceAdapter>
> 
>     <!-- 传输协议 -->
>     <transportConnectors>
>         <!-- Java 客户端（Producer/Consumer）与 ActiveMQ 通信的默认和主要协议。 -->
>         <transportConnector name="openwire" uri="tcp://0.0.0.0:61616?maximumConnections=1000"/>
>         <!-- 用于支持 AMQP 1.0 标准的客户端 -->
>         <transportConnector name="amqp" uri="amqp://0.0.0.0:5672"/>
>         <!-- 用于支持 STOMP 协议的客户端 -->
>         <transportConnector name="stomp" uri="stomp://0.0.0.0:61613"/>
>         <!-- 为浏览器中的 Web 客户端提供原生支持 -->
>         <transportConnector name="ws" uri="ws://0.0.0.0:61614"/>
>     </transportConnectors>
> 
>     <!-- 内存限制 -->
>     <systemUsage>
>         <systemUsage>
>             <memoryUsage>
>                 <memoryUsage limit="1 gb"/> <!-- 堆内存限制 -->
>             </memoryUsage>
>             <storeUsage>
>                 <storeUsage limit="10 gb"/> <!-- 持久化存储限制 -->
>             </storeUsage>
>             <tempUsage>
>                 <tempUsage limit="5 gb"/> <!-- 临时文件限制 -->
>             </tempUsage>
>         </systemUsage>
>     </systemUsage>
> </broker>
> 
> 
> 
>     <import resource="jetty.xml"/>
> 
> </beans>
> 
> ```

```bash
# 备份
cp jetty.xml jetty.xml.bak

# 配置（修改，内容↓）
vi jetty.xml
```

> ```xml
> <bean id="jettyPort" class="org.apache.activemq.web.WebConsolePort" init-method="start">
>     <property name="host" value="0.0.0.0"/> <!-- 允许远程访问 -->
>     <property name="port" value="8161"/>
> </bean>
> ```

```bash
# 配置用户认证
vi /opt/activemq/conf/users.properties
```

> ```bash
> # 格式：用户名=密码
> admin=admin
> mk=123456
> ```

```bash
vi /opt/activemq/conf/groups.properties
```

> ```bash
> # 格式：组名=用户列表
> admins=admin
> users=mk
> ```

```bash
# 对于 Web 控制台认证
vi /opt/activemq/conf/jetty-realm.properties
```

> ```bash
> mk: 123456, admin
> ```



## 2.启动

```bash
# 创建 Systemd 服务
vi /etc/systemd/system/activemq.service
```

> ```bash
> [Unit]
> Description=Apache ActiveMQ
> After=network.target
> 
> [Service]
> Type=forking
> User=activemq
> Group=activemq
> Environment=JAVA_HOME=/usr/lib/jvm/jdk-17.0.15+6
> ExecStart=/opt/activemq/bin/activemq start
> ExecStop=/opt/activemq/bin/activemq stop
> Restart=on-failure
> RestartSec=5
> PIDFile=/opt/activemq/data/activemq.pid
> 
> [Install]
> WantedBy=multi-user.target
> ```

```bash
# 当你创建了一个新的服务文件，或者修改了任何一个现有的服务文件（如 .service, .socket, .timer等）后，你必须运行这个命令来让 systemd 知晓这些变化。
systemctl daemon-reload

# 立即运行服务
systemctl start activemq

# 配置开机自启
systemctl enable activemq

# 状态
systemctl status activemq

# 重启
systemctl restart activemq


# 查看日志
tail -f /opt/activemq/data/activemq.log

# 开放端口
firewall-cmd --permanent --add-port=61616/tcp   # OpenWire
firewall-cmd --permanent --add-port=5672/tcp    # AMQP
firewall-cmd --permanent --add-port=61613/tcp   # STOMP
firewall-cmd --permanent --add-port=61614/tcp   # WebSockets
firewall-cmd --permanent --add-port=8161/tcp    # Web Console
firewall-cmd --permanent --add-port=61617/tcp   # SSL
# 重载防火墙
firewall-cmd --reload

# 页面后台登录
http://10.50.10.113:8161/
```

