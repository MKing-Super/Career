# Kafka搭建

- kafka_2.13-3.2.0.tgz

> https://archive.apache.org/dist/kafka/3.2.0/kafka_2.13-3.2.0.tgz

| **用途**         | **路径**                | **说明**                              |
| ---------------- | ----------------------- | ------------------------------------- |
| **软件安装目录** | `/opt/kafka/`           | 存放 Kafka 二进制文件                 |
| **数据存储目录** | `/data/kafka-logs/`     | Kafka 消息日志                        |
|                  | `/data/zookeeper-data/` | ZooKeeper 数据快照和日志              |
| **日志文件目录** | `/opt/kafka/logs/`      | Kafka 应用运行日志                    |
| **系统服务文件** | `/etc/systemd/system/`  | `zookeeper.service`和 `kafka.service` |

## 一、安裝

1 java

若有则跳过

```bash
# 1. 更新系统
yum update -y

# 2. 安装必需的软件包，包括 Java
yum install -y wget java-1.8.0-openjdk java-1.8.0-openjdk-devel

# 3. 验证 Java 安装（Kafka 需要 Java 8 或 11）
java -version
```

2 创建专用用户和目录

```bash
# 1. 创建系统用户和组 'kafka'，并禁止登录 shell
useradd -r -s /bin/false kafka

# 2. 创建我们规划好的数据目录，并赋予 'kafka' 用户所有权
mkdir -p /data/kafka-logs /data/zookeeper-data
chown -R kafka:kafka /data/kafka-logs /data/zookeeper-data

# 3. 创建软件安装目录
mkdir -p /opt/kafka
chown -R kafka:kafka /opt/kafka
```

3 下载和安转kafka

```bash
# 1. 切换到我们创建的 'kafka' 用户。
# '-s /bin/bash' 是临时赋予一个 shell 以便执行安装命令。
sudo su - kafka -s /bin/bash

# 2. 进入我们规划好的安装目录
cd /opt/kafka

# 3. 下载 Kafka 二进制包（请替换为官方最新稳定版本链接）
# 可以从 https://kafka.apache.org/downloads 获取
wget https://archive.apache.org/dist/kafka/3.2.0/kafka_2.13-3.2.0.tgz
# 也可先下载 kafka_2.13-3.2.0.tgz 包，再从centos7安转

# 4. 解压
tar -xzf kafka_2.13-3.2.0.tgz

# 5. 创建软链接以便后续管理和升级
ln -s kafka_2.13-3.2.0 current

# 6. 退出 kafka 用户的 shell
exit
```

4 配置zookeeper

```bash
# 使用 root 或 sudo 编辑 ZooKeeper 配置文件
cd /opt/kafka/current/config
mv zookeeper.properties zookeeper.properties.bak
vim /opt/kafka/current/config/zookeeper.properties


# 找到并修改 'dataDir' 这一行，指向我们创建的数据目录
dataDir=/data/zookeeper-data
clientPort=2181
admin.enableServer=false

# (可选) 为了更好的稳定性，可以调整以下参数
# 客户端连接的最大超时时间
maxClientCnxns=100
# 心跳间隔单位（毫秒）
tickTime=2000
# 初始化连接时的最长心跳倍数
initLimit=10
# 心跳请求与应答的最长心跳倍数
syncLimit=5
```

5 配置kafka

```bash
# 编辑 Kafka Server 配置文件
cd /opt/kafka/current/config
mv server.properties server.properties.bak
vim /opt/kafka/current/config/server.properties

# 找到并修改以下关键配置：
# ----------------------------
# Broker 的唯一标识符，单机保持默认即可
broker.id=0
# 监听地址，改为 0.0.0.0 或内网 IP 以便其他机器访问
# listeners=PLAINTEXT://0.0.0.0:9092
listeners=PLAINTEXT://localhost:9092
# 日志目录，指向我们创建的数据目录
log.dirs=/data/kafka-logs
# ZooKeeper 连接地址，单机本地运行
zookeeper.connect=localhost:2181
# ----------------------------

# (可选) 性能与运维调优参数（根据你的服务器配置调整）
# 默认分区数
num.partitions=3
# 日志文件删除前保留的时间（小时）
log.retention.hours=168
# 每个日志文件段的最大大小
log.segment.bytes=1073741824
# 网络线程数
num.network.threads=4
# IO 线程数
num.io.threads=8

# 添加或修改以下配置
offsets.topic.replication.factor=1
transaction.state.log.replication.factor=1
transaction.state.log.min.isr=1
```

6 创建 ZooKeeper 服务

```bash
vim /etc/systemd/system/zookeeper.service


[Unit]
Description=Apache Zookeeper Server (Kafka)
Documentation=http://zookeeper.apache.org
Requires=network.target
After=network.target

[Service]
Type=simple
User=kafka
Group=kafka
ExecStart=/opt/kafka/current/bin/zookeeper-server-start.sh /opt/kafka/current/config/zookeeper.properties
ExecStop=/opt/kafka/current/bin/zookeeper-server-stop.sh
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

7 创建 Kafka 服务

```bash
vim /etc/systemd/system/kafka.service


[Unit]
Description=Apache Kafka Server
Documentation=http://kafka.apache.org/documentation.html
Requires=zookeeper.service
After=zookeeper.service

[Service]
Type=simple
User=kafka
Group=kafka
# 设置环境变量，明确指定日志目录
Environment="LOG_DIR=/opt/kafka/current/logs"
ExecStart=/opt/kafka/current/bin/kafka-server-start.sh /opt/kafka/current/config/server.properties
ExecStop=/opt/kafka/current/bin/kafka-server-stop.sh
Restart=on-failure
RestartSec=10s

[Install]
WantedBy=multi-user.target
```

8 启动

```bash
# 重新加载 systemd 配置，使其识别新的服务文件
systemctl daemon-reload

# 启动 ZooKeeper 并设置开机自启
systemctl start zookeeper
systemctl enable zookeeper

# 启动 Kafka 并设置开机自启
systemctl start kafka
systemctl enable kafka

# 检查服务状态，确保均为 active (running)
systemctl status zookeeper
systemctl status kafka

# 查看 Kafka 的实时日志（Ctrl+C 退出）
journalctl -u kafka -f
```

> 重启：
>
> systemctl restart zookeeper
>
> systemctl restart kafka
>
> 关闭：
>
> systemctl stop kafka
>
> systemctl stop zookeeper

9 防火墙

```bash
# 开放 Kafka 默认端口 9092 和 ZooKeeper 端口 2181
firewall-cmd --permanent --add-port=9092/tcp
firewall-cmd --permanent --add-port=2181/tcp
firewall-cmd --reload
```

10 功能测试

```bash
# 1. 创建测试主题 'test-topic'
sudo /opt/kafka/current/bin/kafka-topics.sh --create \
    --bootstrap-server localhost:9092 \
    --replication-factor 1 \
    --partitions 1 \
    --topic test-topic

# 2. 查看主题列表，应能看到 'test-topic'
sudo /opt/kafka/current/bin/kafka-topics.sh --list \
    --bootstrap-server localhost:9092

# 3. 启动一个控制台消费者来等待接收消息
sudo /opt/kafka/current/bin/kafka-console-consumer.sh \
    --bootstrap-server localhost:9092 \
    --topic test-topic \
    --from-beginning

# 4. 打开另一个终端窗口，启动生产者并发送几条消息
sudo /opt/kafka/current/bin/kafka-console-producer.sh \
    --bootstrap-server localhost:9092 \
    --topic test-topic
>Hello, Kafka on CentOS 7!
>This is a test message.

# 5. 回到消费者终端，你应该能立刻看到刚刚发送的消息。
# 测试成功！
```

11 其他命令（选）

```bash
/opt/kafka/current/bin/kafka-topics.sh \
    --bootstrap-server localhost:9092 \
    --delete \
    --topic test-topic
```

