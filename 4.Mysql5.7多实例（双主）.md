# Mysql5.7多实例

10.50.10.3

## 1 前提

```bash
mkdir -p /mysql/{master1,master2}/{data,logs,tmp}
chown -R mysql:mysql /mysql

mysqld --initialize-insecure --user=mysql --datadir=/mysql/master1/data
mysqld --initialize-insecure --user=mysql --datadir=/mysql/master2/data

```

## 2 配置文件

主库1

```
vi /etc/mysql/master1.cnf
```

> [mysqld]
> server-id = 1
> log_bin = /mysql/master1/logs/mysql-bin
> binlog_format = ROW
> binlog_row_image = FULL
> log_slave_updates = ON
> auto_increment_increment = 2
> auto_increment_offset = 1
> datadir = /mysql/master1/data
> socket = /mysql/master1/mysql.sock
> port = 3307
> pid-file = /mysql/master1/mysql.pid
> log-error = /mysql/master1/logs/error.log
> tmpdir = /mysql/master1/tmp
>
> 
>
> character-set-server = utf8mb4
> collation-server = utf8mb4_unicode_ci
>
> [client]
> default-character-set = utf8mb4
>
> [mysql]
> default-character-set = utf8mb4

主库2

```
vi /etc/mysql/master2.cnf
```

> [mysqld]
> server-id = 2
> log_bin = /mysql/master2/logs/mysql-bin
> binlog_format = ROW
> binlog_row_image = FULL
> log_slave_updates = ON
> auto_increment_increment = 2
> auto_increment_offset = 2
> datadir = /mysql/master2/data
> socket = /mysql/master2/mysql.sock
> port = 3308
> pid-file = /mysql/master2/mysql.pid
> log-error = /mysql/master2/logs/error.log
> tmpdir = /mysql/master2/tmp
>
> 
>
> character-set-server = utf8mb4
> collation-server = utf8mb4_unicode_ci
>
> [client]
> default-character-set = utf8mb4
>
> [mysql]
> default-character-set = utf8mb4

启动双实例

```
-- 开发linux端口
[root@localhost mysql]# firewall-cmd --add-port=3307/tcp --permanent
[root@localhost mysql]# firewall-cmd --add-port=3308/tcp --permanent
[root@localhost mysql]# firewall-cmd --reload
```

## 3 双主启动

master1

```
mysqld_safe --defaults-file=/etc/mysql/master1.cnf &
```

> Ctrl + c 退出放入后台
>
> 停止mysql
>
> ```
> mysqladmin -uroot -P3307 -S /mysql/master1/mysql.sock shutdown
> ```

```
[root@localhost /]# mysql -uroot -P3307 -S /mysql/master1/mysql.sock


mysql> 
CREATE USER 'mk'@'%' IDENTIFIED BY '123456';
GRANT REPLICATION SLAVE ON *.* TO 'mk'@'%';
FLUSH PRIVILEGES;
```



master2

```
mysqld_safe --defaults-file=/etc/mysql/master2.cnf &
```

> Ctrl + c 退出放入后台
>
> 停止mysql
>
> ```
> mysqladmin -uroot -P3308 -S /mysql/master2/mysql.sock shutdown
> ```

```
[root@localhost /]# mysql -uroot -P3308 -S /mysql/master2/mysql.sock


mysql> 
CREATE USER 'mk'@'%' IDENTIFIED BY '123456';
GRANT REPLICATION SLAVE ON *.* TO 'mk'@'%';
FLUSH PRIVILEGES;
```





查看master1、master2的状态，记下file和position

```
SHOW MASTER STATUS;
```

> master1	mysql-bin.000003	154 
>
> master2	mysql-bin.000001	758

master1

```
[root@localhost /]# mysql -uroot -P3307 -S /mysql/master1/mysql.sock


mysql> 
CHANGE MASTER TO
MASTER_HOST='localhost',
MASTER_USER='mk',
MASTER_PASSWORD='123456',
MASTER_PORT=3308,
MASTER_LOG_FILE='mysql-bin.000001',
MASTER_LOG_POS=758;
START SLAVE;
```

master2

```
[root@localhost /]# mysql -uroot -P3308 -S /mysql/master2/mysql.sock

CHANGE MASTER TO
MASTER_HOST='localhost',
MASTER_USER='mk',
MASTER_PASSWORD='123456',
MASTER_PORT=3307,
MASTER_LOG_FILE='mysql-bin.000003',
MASTER_LOG_POS=154;
START SLAVE;
```

## 4 双主验证

```
SHOW SLAVE STATUS\G
-- 确保Slave_IO_Running和Slave_SQL_Running都是Yes
```

测试同步

```sql
-- root 在主库1创建测试数据
CREATE DATABASE mk_work;

-- 在主1，2检查用户权限
SHOW GRANTS FOR 'mk'@'%';
-- 在主1，2授予用户权限
GRANT ALL PRIVILEGES ON mk_work.* TO 'mk'@'%';
-- 刷新
FLUSH PRIVILEGES;

-- 在主库1创建测试数据
USE mk_work;
CREATE TABLE mk_work.test(id INT AUTO_INCREMENT PRIMARY KEY, data VARCHAR(100));
INSERT INTO mk_work.test(data) VALUES('来自主库1的数据');

-- 在主库2检查数据
SELECT * FROM mk_work.test;

-- 在主库2插入数据
INSERT INTO mk_work.test(data) VALUES('来自主库2的数据');

-- 在主库1检查数据
SELECT * FROM mk_work.test;


-- root 在主库1删测试数据
DROP DATABASE mk_work;
```

